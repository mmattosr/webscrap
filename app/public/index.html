<html>

<head></head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

  <div id="app">
    <p>Instance: {{instance}}</p>
    <form @submit="login">
      <label for='username'>Usu√°rio</label>
      <input id='username' v-model='username'>

      <label for='password'>Senha</label>
      <input id='password' type='password' v-model='password'>

      <button type='submit'>Entrar</button>
    </form>
    <div v-if='qrcode'>
      <img :src='qrcode' alt='scan me!'>
    </div>
    <button type='buton' v-if='instance' @click='exit'>Fechar</button>
    <button type='buton' v-if='instance' @click='getData'>Exibir dados</button>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        username: 'marcelo.mattos',
        password: 'fake-secret',
        instance: undefined,
        qrcode: undefined
      },
      mounted: function () {
        if (!this.instance) {
          this.init()
        }
      },
      methods: {
        async init() {
          const { id } = await fetch('/nubank', { method: 'POST' }).then(r => r.json())
          // TODO: persist this on local storage
          this.instance = id
        },

        async login(e) {
          e.preventDefault()
          const options = {
            method: 'POST',
            body: JSON.stringify({
              username: this.username,
              // TODO: hash password before send
              password: this.password
            }),
            headers: {
              'Content-type': 'application/json'
            }
          }
          const result = await fetch(`/nubank/${this.instance}/login`, options).then(r => r.json())
          if(result.qrcode) {
            this.qrcode = result.qrcode
          } else {
            console.log('something went wrong')
            // something went wrong
          }
        },

        async exit(e) {
          const result = await fetch(`/nubank/${this.instance}/exit`, { method: 'POST' }).then(r => r.json())
          console.log(result)
        },

        async getData(e) {
          const result = await fetch(`/nubank/${this.instance}/data`).then(r => r.json())
          console.log(result)
        }
      }
    })
  </script>
</body>

</html>